<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë¨¼íŠ¸í”Œë¡œìš° ê²¬ì ì„œ</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS CDN ë¡œë“œ (ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì¶”ê°€) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        /* ì¸ì‡„ ì‹œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¸°ê¸° */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            #quotation-output {
                width: 100%;
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }
            input, textarea, select {
                border: none !important;
                background: transparent !important;
                resize: none;
                padding: 0;
                margin: 0;
                box-shadow: none !important;
                appearance: none;
            }
            input[type="number"] {
                appearance: none;
                -moz-appearance: textfield;
                text-align: right;
            }
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            tr { page-break-inside: avoid; }
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        /* ê²¬ì  í•­ëª© ì¹´ë“œ ì¸í„°ë™ì…˜ */
        .item-card {
            transition: all 0.2s ease;
            cursor: grab;
        }
        .item-card:active {
            cursor: grabbing;
        }
        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .item-card:hover .card-actions {
            opacity: 1;
        }
        /* SortableJS ghost class */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e0e7ff;
            border: 2px dashed #a5b4fc;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6">

        <!-- ì™¼ìª½: ê²¬ì  í•­ëª© ê´€ë¦¬ íŒ¨ë„ -->
        <div id="item-selection-panel" class="no-print lg:w-1/3 bg-white p-5 rounded-xl shadow-md h-full flex flex-col border border-gray-200">
            <h1 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-100 flex justify-between items-center">
                <span>ğŸ“¦ í•­ëª© ê´€ë¦¬</span>        
                </h1>

            
            <!-- í•­ëª© ë¦¬ìŠ¤íŠ¸ (ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™”) -->
            <div class="flex-grow overflow-hidden flex flex-col mb-4">
                 
                <div id="item-grid" class="flex-grow hide-scrollbar overflow-y-auto pr-1 pb-2 space-y-6" style="max-height: 500px;">
                    <!-- í•­ëª©ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                    <div id="loading-indicator" class="text-center p-8 text-gray-500 hidden">
                        <!-- ì´ˆê¸° ë¡œë“œ í›„ ìˆ¨ê¹€ -->
                        <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        í•­ëª© ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>

            <!-- ì§ì ‘ ì…ë ¥ í¼ (ëŒ€ë¶„ë¥˜ ì¶”ê°€) -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-inner mt-auto">
                <label class="block text-xs font-semibold text-gray-500 mb-3">â• ìƒˆ í•­ëª© ë“±ë¡</label>
                <div class="flex flex-col gap-3">
                    <!-- ëŒ€ë¶„ë¥˜ ì„ íƒ -->
                    <div>
                        <select id="new-item-category" class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:border-indigo-500 bg-white">
                            <option value="" disabled selected>ëŒ€ë¶„ë¥˜ ì„ íƒ</option>
                            <option value="ê¸°íš">ê¸°íš</option>
                            <option value="ë””ìì¸">ë””ìì¸</option>
                            <option value="í¸ì§‘">í¸ì§‘</option>
                            <option value="ëª¨ì…˜ê·¸ë˜í”½">ëª¨ì…˜ê·¸ë˜í”½</option>
                            <option value="ìŒì› ë° ì˜¤ë””ì˜¤">ìŒì› ë° ì˜¤ë””ì˜¤</option>
                            <option value="ì¶”ê°€ì˜µì…˜">ì¶”ê°€ì˜µì…˜</option>
                        </select>
                    </div>

                    <input type="text" id="new-item-name" placeholder="í•­ëª©ëª… (ì˜ˆ: ìƒì„¸ ê¸°íšì•ˆ)" class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:border-indigo-500">
                    
                    <div class="flex gap-2">
                        <input type="number" id="new-item-price" placeholder="ë‹¨ê°€ (ì›)" class="w-2/3 p-2 border border-gray-300 rounded text-sm focus:outline-none focus:border-indigo-500">
                        <button onclick="addNewCustomItem()" class="w-1/3 bg-gray-800 hover:bg-gray-900 text-white text-xs font-bold rounded transition shadow-sm">
                            ë“±ë¡
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê²¬ì ì„œ ì‘ì„± ë° ë¯¸ë¦¬ë³´ê¸° -->
        <div class="lg:w-2/3 flex flex-col gap-4">
            
            <!-- ê²¬ì ì„œ ë³¸ë¬¸ -->
            <div id="quotation-output" class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 min-h-[800px] flex flex-col">
                <div id="print-area" class="flex-grow flex flex-col justify-between h-full">
                    
                    <!-- ìƒë‹¨ í—¤ë” -->
                    <div>
                        <div class="flex justify-between items-end border-b-2 border-gray-800 pb-4 mb-8">
                            <div>
                                <h2 class="text-4xl font-extrabold text-gray-900 tracking-tight">ê²¬ ì  ì„œ</h2>
                                <p class="text-sm text-gray-500 mt-1 font-medium">ESTIMATE SHEET</p>
                            </div>
                            <div class="text-right">
                                                                <p class="text-sm text-gray-600">ê²¬ì ì¼ì <span id="issue-date"></span></p>
                            </div>
                        </div>

                        <!-- ê³µê¸‰ë°›ëŠ”ì / ê³µê¸‰ì ì •ë³´ -->
                        <div class="flex flex-col md:flex-row justify-between gap-4 mb-4">
                            
                            <!-- ìˆ˜ì‹  (ì™¼ìª½: ì¢ê²Œ w-1/3) -->
                            <div class="w-full md:w-1/4 flex flex-col">
                                <table class="w-full text-sm border-collapse border border-gray-300 shadow-sm h-full">
                                    <tr class="h-full">
                                        <td class="bg-gray-100 border border-gray-300 p-2 font-bold w-10 text-center align-middle">ìˆ˜<br>ì‹ </td> <td class="border border-gray-300 p-2 bg-white align-middle">
                                            <div class="flex items-center h-full">
                                                <input type="text" id="display-customer-name" value="ê³ ê°ì‚¬/ë‹´ë‹¹ì" class="font-bold text-gray-800 text-xs w-full bg-transparent focus:outline-none border-b border-dashed border-gray-300 focus:border-indigo-500 placeholder-gray-400 text-center" placeholder="ì´ë¦„ ì…ë ¥"> <span class="ml-1 whitespace-nowrap">ê·€í•˜</span>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- ê³µê¸‰ì (ì˜¤ë¥¸ìª½: ë„“ê²Œ w-2/3) -->
                            <div class="w-full md:w-3/4 text-sm">
                                <table class="w-full border-collapse border border-gray-300 shadow-sm h-full">
                                    <tr>
                                        <td rowspan="4" class="bg-gray-100 border border-gray-300 p-2 w-8 font-bold text-center writing-vertical align-middle">ê³µ<br>ê¸‰<br>ì</td>
                                        <td class="bg-gray-50 border border-gray-300 p-1 w-20 text-center font-bold text-xs align-middle">ì‚¬ì—…ìë²ˆí˜¸</td>
                                        <td colspan="3" class="border border-gray-300 p-1 text-center bg-white align-middle">
                                            <input type="text" value="104-30-99627" class="w-full text-center bg-transparent focus:outline-none" placeholder="ì‚¬ì—…ìë²ˆí˜¸ ì…ë ¥">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="bg-gray-50 border border-gray-300 p-1 text-center font-bold text-xs align-middle">ìƒ í˜¸</td>
                                        <td class="border border-gray-300 p-1 text-center bg-white align-middle">
                                            <input type="text" value="ëª¨ë¨¼íŠ¸í”Œë¡œìš°" class="w-full text-center bg-transparent focus:outline-none" placeholder="ìƒí˜¸ëª…">
                                        </td>
                                        <td class="bg-gray-50 border border-gray-300 p-1 w-14 text-center font-bold text-xs align-middle">ëŒ€ í‘œ</td>
                                        <td class="border border-gray-300 p-1 text-center bg-white align-middle">
                                            <input type="text" value="ì—„ì„±ë¯¸" class="w-full text-center bg-transparent focus:outline-none" placeholder="ëŒ€í‘œìëª…">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="bg-gray-50 border border-gray-300 p-1 text-center font-bold text-xs align-middle">ì‚¬ì—…ì¥ì£¼ì†Œ</td>
                                        <td colspan="3" class="border border-gray-300 p-1 text-center bg-white text-xs align-middle">
                                            <input type="text" value="ë¶€ì‚° ì—°ì œêµ¬ í† í˜„ë¡œ 10 ë§ë¯¸ì£¼ê³µì•„íŒŒíŠ¸ 103ë™ 1004í˜¸" class="w-full text-center bg-transparent focus:outline-none" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="bg-gray-50 border border-gray-300 p-1 text-center font-bold text-xs align-middle">ì—… íƒœ</td>
                                        <td class="border border-gray-300 p-1 text-center bg-white text-xs align-middle">
                                            <input type="text" value="ì •ë³´í†µì‹ ì—…" class="w-full text-center bg-transparent focus:outline-none" placeholder="ì—…íƒœ">
                                        </td>
                                        <td class="bg-gray-50 border border-gray-300 p-1 text-center font-bold text-xs align-middle">ì¢… ëª©</td>
                                        <td class="border border-gray-300 p-1 text-center bg-white text-xs align-align-middle">
                                            <input type="text" value="ì• ë‹ˆë©”ì´ì…˜ ì˜í™” ë° ë¹„ë””ì˜¤ë¬¼ ì œì‘ì—…" class="w-full text-center bg-transparent focus:outline-none" placeholder="ì¢…ëª©">
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- í•©ê³„ ì¹¸ -->
                        <div class="mb-8">
                            <table class="w-full text-sm border-collapse border border-gray-300 shadow-sm">
                                <tr>
                                    <td class="bg-indigo-50 border border-gray-300 p-3 font-bold text-center text-indigo-900 w-32 text-base">í•© ê³„ ê¸ˆ ì•¡</td>
                                    <td class="border border-gray-300 p-3 font-bold text-right pr-6 bg-white text-indigo-700 text-2xl" id="table-grand-total">0 ì›</td>
                                </tr>
                            </table>
                        </div>

                        <p class="text-sm mb-2 text-gray-600 font-medium">ì•„ë˜ì™€ ê°™ì´ ê²¬ì í•©ë‹ˆë‹¤.</p>

                        <!-- ìƒì„¸ í…Œì´ë¸” -->
                        <div class="w-full mb-6">
                            <table class="w-full border-collapse border border-gray-400 text-sm">
                                <thead class="bg-gray-100 text-gray-700">
                                    <tr>
                                        <th class="border border-gray-400 p-2 w-12 text-center">No</th>
                                        <th class="border border-gray-400 p-2 text-center">í’ˆ ëª… / í•­ ëª©</th>
                                        <th class="border border-gray-400 p-2 w-16 text-center">ìˆ˜ ëŸ‰</th>
                                        <th class="border border-gray-400 p-2 w-28 text-center">ë‹¨ ê°€</th>
                                        <th class="border border-gray-400 p-2 w-28 text-center">ê³µê¸‰ê°€ì•¡</th>
                                        <th class="border border-gray-400 p-2 w-24 text-center">ì„¸ ì•¡</th>
                                    </tr>
                                </thead>
                                <tbody id="quote-items-body" class="text-gray-800">
                                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë Œë”ë§ -->
                                </tbody>
                                <tfoot class="bg-gray-50 font-bold text-gray-800">
                                    <tr>
                                        <td colspan="4" class="border border-gray-400 p-2 text-center bg-gray-100">í•© ê³„ (VAT ë³„ë„)</td>
                                        <td class="border border-gray-400 p-2 text-right pr-3 text-indigo-900" id="sub-total">0</td>
                                        <td class="border border-gray-400 p-2 text-right pr-3 text-gray-600" id="vat-amount">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- í•˜ë‹¨ í‘¸í„° -->
                    <div class="mt-auto">
                        <div class="border-t-2 border-gray-800 pt-4">
                            <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                                <li>ê²¬ì  ìœ íš¨ê¸°ê°„ : ê²¬ì ì¼ë¡œë¶€í„° 15ì¼ê°„ ìœ íš¨í•©ë‹ˆë‹¤.</li>
                                <li>ê²°ì œ ì¡°ê±´ : ì°©ìˆ˜ê¸ˆ 50%, ì”ê¸ˆ 50% (í˜‘ì˜ ê°€ëŠ¥)</li>
                                
                            </ul>
                        </div>
                        <div class="mt-8 text-sm">
                    <div class="flex justify-center mt-6">
                        <img 
                            src="data:image/png;base64,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" 
                            alt="ë¡œê³  ì´ë¯¸ì§€" 
                            class="h-2.5"
                        > 
                    </div>
                </div>
                    </div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ë²„íŠ¼ ë°” -->
            <div class="no-print bg-white p-4 rounded-xl shadow-lg flex justify-center items-center border border-gray-200">
                
                <div class="flex gap-2">
                    <button onclick="clearQuote()" class="bg-white hover:bg-red-50 text-red-500 hover:text-red-600 font-semibold py-2.5 px-5 rounded-lg transition duration-150 border border-red-200 text-sm flex items-center gap-2 shadow-sm">
                        <span>ğŸ”„ ì´ˆê¸°í™”</span>
                    </button>
                    <button onclick="printQuote()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-6 rounded-lg transition duration-150 shadow-md flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        <span>ì¸ì‡„ / ì €ì¥</span>
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Custom Modal Structure (for prompt/confirm replacement) -->
    <div id="custom-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 items-center justify-center transition-opacity duration-300">
        <div id="custom-modal-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-transform duration-300 scale-95">
            <!-- Content will be injected here -->
        </div>
    </div>


    <script>
        
        // === ê³ ê°ë‹˜ì´ ì œê³µí•œ CSV ë°ì´í„° ===
        // CSV íŒŒì¼ ë‚´ìš©: "estimate sheet.xlsx - Estimate.csv"
        const csvData = `,ì˜ìƒ ë‹¨ê°€í‘œ,
ëŒ€ë¶„ë¥˜,ì„¸ë¶€ í•­ëª©,ë‹¨ê°€(ì›)
ê¸°íš,ì‹œë‚˜ë¦¬ì˜¤ ê¸°íš,800000
ê¸°íš,ë‚´ë ˆì´ì…˜ ì›ê³  ì‘ì„±,200000
ë””ìì¸,"ê·¸ë˜í”½, ì˜ìƒ ì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤",100000
ë””ìì¸,ì•„ì´ì½˜/ì¼ëŸ¬ìŠ¤íŠ¸ ì œì‘,200000
ë””ìì¸,ìºë¦­í„° ì œì‘,200000
ì˜ìƒ í¸ì§‘,ì»·í¸ì§‘,800000
ì˜ìƒ í¸ì§‘,ê¸°ë³¸ìë§‰,100000
ì˜ìƒ í¸ì§‘,ìë§‰ë””ìì¸,150000
ì˜ìƒ í¸ì§‘,ìƒ‰ë³´ì •/ë§ˆê°,300000
ëª¨ì…˜ê·¸ë˜í”½,ìºë¦­í„° ì• ë‹ˆë©”ì´ì…˜,300000
ëª¨ì…˜ê·¸ë˜í”½,í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜,200000
ëª¨ì…˜ê·¸ë˜í”½,ì•„ì´ì½˜/ê·¸ë˜í”½ ëª¨ì…˜,300000
ìŒì›Â·ì˜¤ë””ì˜¤,BGM ë¼ì´ì„ ìŠ¤,30000
ìŒì›Â·ì˜¤ë””ì˜¤,SFX(íš¨ê³¼ìŒ) ë¹„ìš©,20000
ìŒì›Â·ì˜¤ë””ì˜¤,ìŒì› ë¯¹ì‹±,100000
ì¶”ê°€ ì˜µì…˜,ê¸°ë³¸ ì¸ë„¤ì¼ 1ì¢…,70000
ì¶”ê°€ ì˜µì…˜,ê³ ê¸‰ ì¸ë„¤ì¼(í•©ì„±/ë¦¬í„°ì¹­),120000
ì¶”ê°€ ì˜µì…˜,ìˆí¼ ì¬í¸ì§‘(15/30/60ì´ˆ),100000
ì¶”ê°€ ì˜µì…˜,ê·¸ë˜í”½ ì†ŒìŠ¤,200000
`;

        // === ë°ì´í„° ê´€ë¦¬ ë° ì´ˆê¸° ìƒíƒœ ===
        
        // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì •ì˜: ì´ ëª©ë¡ì— ë§ì¶° CSV ë°ì´í„°ê°€ í†µí•©ë©ë‹ˆë‹¤.
        const CATEGORIES = [
            "ê¸°íš", 
            "ë””ìì¸", 
            "ì˜ìƒì´¬ì˜ë¬¼", // 'ì˜ìƒ ì´¬ì˜ë¬¼' í†µí•©
            "ëª¨ì…˜ê·¸ë˜í”½", 
            "ìŒì› ë° ì˜¤ë””ì˜¤", // 'ìŒì›Â·ì˜¤ë””ì˜¤' í†µí•©
            "ì¶”ê°€ì˜µì…˜" // 'ì¶”ê°€ ì˜µì…˜' í†µí•©
        ];

        // CSV ì¹´í…Œê³ ë¦¬ ëª…ì¹­ê³¼ í†µí•©ë  ëª©í‘œ ëª…ì¹­ ë§¤í•‘
        const CATEGORY_MAP = {
            "ì˜ìƒ ì´¬ì˜ë¬¼": "ì˜ìƒì´¬ì˜ë¬¼",
            "ìŒì›Â·ì˜¤ë””ì˜¤": "ìŒì› ë° ì˜¤ë””ì˜¤",
            "ì¶”ê°€ ì˜µì…˜": "ì¶”ê°€ì˜µì…˜",
        };


        /**
         * CSV ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ í•­ëª© ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         * ì´ í•¨ìˆ˜ ë‚´ì—ì„œ CSV í•­ëª© ëª…ì¹­ì„ ëª©í‘œ ëª…ì¹­ìœ¼ë¡œ í†µí•©í•©ë‹ˆë‹¤.
         * @returns {Array<Object>} í•­ëª© ë°ì´í„° ë°°ì—´
         */
        const parseCsvData = () => {
            const lines = csvData.trim().split('\n');
            if (lines.length < 3) return []; // ìµœì†Œí•œ í—¤ë”ì™€ í•œ ì¤„ì˜ ë°ì´í„°ê°€ ìˆì–´ì•¼ í•¨

            // ì„¸ ë²ˆì§¸ ì¤„ë¶€í„° ë°ì´í„° ì‹œì‘
            const dataLines = lines.slice(3); 
            const items = [];
            
            let idCounter = 1;

            dataLines.forEach((line) => {
                const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                
                if (parts.length >= 3) {
                    let category = parts[0].trim();
                    
                    // ëŒ€ë¶„ë¥˜ í†µí•© ë¡œì§: CSV ëª…ì¹­ì„ ëª©í‘œ ëª…ì¹­ìœ¼ë¡œ ë³€ê²½
                    if (CATEGORY_MAP[category]) {
                        category = CATEGORY_MAP[category];
                    }
                    
                    // ë”°ì˜´í‘œ ì œê±° (ì˜ˆ: "ê·¸ë˜í”½, ì˜ìƒ ì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤" -> ê·¸ë˜í”½, ì˜ìƒ ì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤)
                    const name = parts[1].trim().replace(/^"(.*)"$/, '$1'); 
                    const priceString = parts[2].trim().replace(/,/g, ''); // ì‰¼í‘œ ì œê±°
                    const price = parseInt(priceString) || 0; // ìˆ«ìë¡œ ë³€í™˜, ì‹¤íŒ¨ ì‹œ 0

                    if (category && name) {
                        items.push({
                            id: `csv-${idCounter++}`, 
                            category: category,
                            name: name,
                            price: price,
                            order: idCounter, 
                        });
                    }
                }
            });

            return items;
        };
        
        
        // localStorageì—ì„œ ë¡œë“œë  í•­ëª© ëª©ë¡
        let allItems = []; 
        let selectedItems = []; // ê²¬ì ì„œì— ì¶”ê°€ëœ í•­ëª© (ì„¸ì…˜ ìœ ì§€)
        
        
        // === DOM ìš”ì†Œ ===
        const itemGrid = document.getElementById('item-grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        const quoteItemsBody = document.getElementById('quote-items-body');
        const subTotalElement = document.getElementById('sub-total');
        const vatAmountElement = document.getElementById('vat-amount');
        const tableGrandTotalElement = document.getElementById('table-grand-total');
        const displayCustomerName = document.getElementById('display-customer-name');
        
        // ì…ë ¥ í¼ ìš”ì†Œ
        const newItemCategoryInput = document.getElementById('new-item-category');
        const newItemNameInput = document.getElementById('new-item-name');
        const newItemPriceInput = document.getElementById('new-item-price');

        // ëª¨ë‹¬ ìš”ì†Œ
        const modalBackdrop = document.getElementById('custom-modal-backdrop');
        const modalContent = document.getElementById('custom-modal-content');

        
        // === LocalStorage ë°ì´í„° ê´€ë¦¬ ===

        const LOCAL_STORAGE_KEY = 'masterQuotationItems';

        /**
         * ë¡œì»¬ ì €ì¥ì†Œì—ì„œ í•­ëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
         */
        const loadMasterItemsFromLocal = () => {
            try {
                const storedItems = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedItems) {
                    allItems = JSON.parse(storedItems);
                    // order í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ìˆ«ì ì˜¤ë¦„ì°¨ìˆœ)
                    allItems.sort((a, b) => {
                        const categoryAIndex = CATEGORIES.indexOf(a.category);
                        const categoryBIndex = CATEGORIES.indexOf(b.category);
                        if (categoryAIndex !== categoryBIndex) {
                            return categoryAIndex - categoryBIndex;
                        }
                        return a.order - b.order;
                    });
                } else {
                    // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ CSV ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                    allItems = parseCsvData();
                    saveMasterItemsToLocal(); 
                }
            } catch (error) {
                console.error("Error loading items from localStorage:", error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ CSV ë°ì´í„°ë¡œ ê°•ì œ ì´ˆê¸°í™”
                allItems = parseCsvData(); 
            }
        };

        /**
         * í˜„ì¬ í•­ëª© ëª©ë¡ì„ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        const saveMasterItemsToLocal = () => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allItems));
            } catch (error) {
                console.error("Error saving items to localStorage:", error);
                // ì‚¬ìš©ìì—ê²Œ ì €ì¥ ì‹¤íŒ¨ë¥¼ ì•Œë¦¬ëŠ” ëª¨ë‹¬ ë“±ì„ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            }
        };

        // selectedItemsì˜ ë°ì´í„°ë¥¼ master list (allItems)ì˜ ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        const updateSelectedItemsFromMaster = () => {
            selectedItems = selectedItems.map(sItem => {
                // sItemì˜ sourceIdëŠ” master itemì˜ idì…ë‹ˆë‹¤.
                const masterItem = allItems.find(mItem => mItem.id === sItem.sourceId);
                if (masterItem) {
                    // ì´ë¦„, ë‹¨ê°€, ì¹´í…Œê³ ë¦¬ë¥¼ ë§ˆìŠ¤í„° ë°ì´í„°ë¡œ ë™ê¸°í™”
                    return {
                        ...sItem,
                        category: masterItem.category,
                        name: masterItem.name,
                        price: masterItem.price,
                    };
                }
                // ë§ˆìŠ¤í„°ì—ì„œ ì‚­ì œëœ í•­ëª©ì€ ê²¬ì ì„œì—ì„œë„ ì œê±°í•©ë‹ˆë‹¤.
                return null;
            }).filter(item => item !== null);
        };

        
        // === ì»¤ìŠ¤í…€ ëª¨ë‹¬ ë¡œì§ ===
        
        const showCustomConfirm = (message, onConfirm) => {
            modalContent.innerHTML = `
                <p class="text-lg font-semibold mb-6 text-gray-800">${message}</p>
                <div class="flex justify-end gap-3">
                    <button id="modal-cancel" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">ì·¨ì†Œ</button>
                    <button id="modal-confirm" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 font-medium">í™•ì¸</button>
                </div>
            `;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');

            document.getElementById('modal-confirm').onclick = () => {
                modalBackdrop.classList.add('hidden');
                modalBackdrop.classList.remove('flex');
                onConfirm(true);
            };
            document.getElementById('modal-cancel').onclick = () => {
                modalBackdrop.classList.add('hidden');
                modalBackdrop.classList.remove('flex');
                onConfirm(false);
            };
        };

        const showMasterItemEditModal = (title, currentName, currentPrice, onAccept) => {
            modalContent.innerHTML = `
                <p class="text-xl font-bold mb-4 text-gray-800">${title}</p>
                <div class="space-y-4">
                    <label class="block">
                        <span class="text-sm font-medium text-gray-700">í•­ëª©ëª…</span>
                        <input id="modal-input-name" type="text" value="${currentName.replace(/"/g, '&quot;')}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="í•­ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </label>
                    <label class="block">
                        <span class="text-sm font-medium text-gray-700">ë‹¨ê°€ (ì›)</span>
                        <input id="modal-input-price" type="number" value="${currentPrice}" min="0" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base text-right" placeholder="ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </label>
                </div>
                <div id="modal-error" class="text-red-500 text-sm mt-3 hidden"></div>
                <div class="flex justify-end gap-3 mt-6">
                    <button id="modal-cancel" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">ì·¨ì†Œ</button>
                    <button id="modal-accept" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 font-medium">ì €ì¥</button>
                </div>
            `;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
            
            const inputName = document.getElementById('modal-input-name');
            const inputPrice = document.getElementById('modal-input-price');
            const errorElement = document.getElementById('modal-error');

            inputName.select();
            inputName.focus();

            const handleAccept = () => {
                const newName = inputName.value.trim();
                const newPrice = parseInt(inputPrice.value);

                if (!newName) {
                    errorElement.textContent = "í•­ëª© ì´ë¦„ì€ ë¹„ì–´ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                if (isNaN(newPrice) || newPrice < 0) {
                    errorElement.textContent = "ë‹¨ê°€ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                errorElement.classList.add('hidden');
                modalBackdrop.classList.add('hidden');
                modalBackdrop.classList.remove('flex');

                onAccept({ name: newName, price: newPrice });
            };

            document.getElementById('modal-accept').onclick = handleAccept;
            
            document.getElementById('modal-cancel').onclick = () => {
                modalBackdrop.classList.add('hidden');
                modalBackdrop.classList.remove('flex');
                onAccept(null);
            };

            inputName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    inputPrice.focus();
                }
            });
            inputPrice.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAccept();
                }
            });
        };

        // ìœ í‹¸ë¦¬í‹°: ìˆ«ì í¬ë§·
        const formatNumber = (num) => num.toLocaleString('ko-KR');

        // ì´ˆê¸° ì„¤ì • (ë‚ ì§œ, ë²ˆí˜¸)
const initMetaInfo = () => {
    const today = new Date();
    const dateStr = `${today.getFullYear()}. ${(today.getMonth()+1).toString().padStart(2,'0')}. ${today.getDate().toString().padStart(2,'0')}`;
    document.getElementById('issue-date').textContent = dateStr;
    // ê²¬ì ë²ˆí˜¸ ì„¤ì • ë¡œì§ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
};


        // === ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë° ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§ (Local Storage) ===

        /**
         * SortableJSë¥¼ ì‚¬ìš©í•˜ì—¬ ë“œë˜ê·¸ í›„ í•­ëª© ë°ì´í„° ìˆœì„œë¥¼ ë¡œì»¬ ì €ì¥ì†Œì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        const updateAllItemsOrder = () => {
            // DOM êµ¬ì¡°ë¥¼ ìˆœíšŒí•˜ë©° ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ ìˆœì„œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            CATEGORIES.forEach(category => {
                const container = document.getElementById(`category-grid-${category.replace(/\s/g, '-')}`);
                if (!container) return;
                
                // DOMì—ì„œ ìƒˆë¡œìš´ ìˆœì„œì˜ item id ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const newOrderId = Array.from(container.children)
                                      .map(el => el.dataset.itemId)
                                      .filter(id => id);

                let newOrder = 1;
                newOrderId.forEach(itemId => {
                    const item = allItems.find(i => i.id === itemId);
                    if (item) {
                        item.order = newOrder++;
                    }
                });
            });

            // ëª¨ë“  ìˆœì„œ ì—…ë°ì´íŠ¸ í›„ ì €ì¥
            saveMasterItemsToLocal();
            // ì¬ì •ë ¬ëœ ìƒíƒœë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•´ ë‹¤ì‹œ ë¡œë“œí•˜ê³  ë Œë”ë§í•©ë‹ˆë‹¤.
            loadMasterItemsFromLocal();
            renderItemCards();
        };


        /**
         * SortableJSë¥¼ ì´ˆê¸°í™”í•˜ì—¬ í•­ëª©ì„ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
         */
        const initSortable = () => {
            const containers = document.querySelectorAll('.category-sortable-container');
            
            containers.forEach(container => {
                // ì´ì „ì— ì´ˆê¸°í™”ëœ Sortable ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
                if (container.sortable) {
                    container.sortable.destroy();
                }

                container.sortable = new Sortable(container, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    handle: '.item-card',
                    group: 'category-items',
                    
                    onEnd: function (evt) {
                        // DOM ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ, underlying data(Local Storage)ë„ ì—…ë°ì´íŠ¸
                        updateAllItemsOrder();
                    }
                });
            });
        };


        // === ì™¼ìª½ íŒ¨ë„: ì•„ì´í…œ ëª©ë¡ ë Œë”ë§ ===
        const renderItemCards = () => {
            itemGrid.innerHTML = '';
            
            if (allItems.length === 0) {
                 const placeholder = document.createElement('div');
                 placeholder.className = "text-center p-8 text-gray-500 italic";
                 placeholder.textContent = "ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í•­ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!";
                 itemGrid.appendChild(placeholder);
                 return;
            }

            // ì¹´í…Œê³ ë¦¬ ìˆœì„œëŒ€ë¡œ ë Œë”ë§
            CATEGORIES.forEach(category => {
                // ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì¶”ê°€í•˜ì—¬ category ì†ì„±ì´ ìˆëŠ” í•­ëª©ë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
                // loadMasterItemsFromLocalì—ì„œ order ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìœ¼ë¯€ë¡œ ë³„ë„ ì •ë ¬ì€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
                const itemsInCategory = allItems.filter(item => item && item.category === category);
                
                if (itemsInCategory.length > 0) {
                    const section = document.createElement('div');
                    section.className = 'mb-2';
                    
                    const header = document.createElement('h3');
                    header.className = 'text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-md inline-block mb-2 border border-indigo-100';
                    header.textContent = category;
                    section.appendChild(header);

                    const grid = document.createElement('div');
                    grid.id = `category-grid-${category.replace(/\s/g, '-')}`;
                    grid.className = 'grid grid-cols-1 gap-2 category-sortable-container'; 

                    itemsInCategory.forEach(item => {
                        const card = document.createElement('div');
                        // idë¥¼ ë°ì´í„° ì†ì„±ì— ì €ì¥
                        card.dataset.itemId = item.id; 
                        card.className = 'item-card group bg-white p-3 border border-gray-200 rounded-lg shadow-sm hover:shadow-md relative cursor-pointer flex justify-between items-center';
                        
                        // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
                        card.onclick = (e) => {
                            // ë²„íŠ¼ í´ë¦­ì„ ì œì™¸í•˜ê³  í•­ëª© ì¶”ê°€
                            if (e.target.closest('button')) {
                                return;
                            }
                            addItemToQuote(item);
                        };

                        card.innerHTML = `
                            <div>
                                <p class="text-sm font-semibold text-gray-700">${item.name}</p>
                                <p class="text-xs text-gray-500 mt-0.5">${formatNumber(item.price)}ì›</p>
                            </div>
                            
                            <div class="card-actions flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <button onclick="editMasterItem('${item.id}', event)" class="p-2 bg-gray-100 hover:bg-blue-100 text-blue-600 rounded text-xs" title="ìˆ˜ì •">âœï¸</button>
                                <button onclick="deleteMasterItem('${item.id}', event)" class="p-2 bg-gray-100 hover:bg-red-100 text-red-500 rounded text-xs" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                            </div>
                        `;
                        grid.appendChild(card);
                    });

                    section.appendChild(grid);
                    itemGrid.appendChild(section);
                }
            });
            initSortable(); // í•­ëª© ëª©ë¡ì„ ë Œë”ë§í•œ í›„ SortableJSë¥¼ ì¬ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        };

        // [ì™¼ìª½ íŒ¨ë„] ìƒˆ í•­ëª© ì¶”ê°€ (Local Storage)
        window.addNewCustomItem = () => {
            const category = newItemCategoryInput.value;
            const name = newItemNameInput.value.trim();
            const price = parseInt(newItemPriceInput.value.replace(/,/g, ''));

            if (!category) return console.error("ì˜¤ë¥˜: ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if (!name) return console.error("ì˜¤ë¥˜: í•­ëª© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (isNaN(price) || price < 0) return console.error("ì˜¤ë¥˜: ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            // í˜„ì¬ ì¡´ì¬í•˜ëŠ” ê°€ì¥ í° order ê°’ + 1ì„ ìƒˆ í•­ëª©ì˜ order ê°’ìœ¼ë¡œ ì‚¬ìš©
            const maxOrder = allItems.reduce((max, item) => Math.max(max, item.order || 0), 0);
            const newOrder = maxOrder + 1;

            const newItemData = { 
                id: crypto.randomUUID(), // ê³ ìœ  ID ìƒì„±
                category: category,
                name: name, 
                price: price,
                order: newOrder,
            };
            
            allItems.push(newItemData);
            saveMasterItemsToLocal();
            loadMasterItemsFromLocal(); // ì •ë ¬ í›„ ë¡œë“œ
            renderItemCards();
            
            // ì…ë ¥ í¼ ì´ˆê¸°í™”
            newItemNameInput.value = '';
            newItemPriceInput.value = '';
            newItemCategoryInput.value = ''; // ì„ íƒ ì´ˆê¸°í™”
            newItemNameInput.focus();
        };

        // [ì™¼ìª½ íŒ¨ë„] í•­ëª© ì‚­ì œ (Local Storage)
        window.deleteMasterItem = (id, event) => {
            if (event) event.stopPropagation();

            showCustomConfirm("ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²¬ì ì„œì—ì„œë„ ì œê±°ë©ë‹ˆë‹¤.", (isConfirmed) => {
                if (isConfirmed) {
                    allItems = allItems.filter(item => item.id !== id);
                    saveMasterItemsToLocal();
                    
                    // ì‚­ì œëœ í•­ëª©ì´ ê²¬ì ì„œì— ìˆìœ¼ë©´ ì œê±°í•˜ê³  ê²¬ì ì„œë„ ê°±ì‹ 
                    updateSelectedItemsFromMaster(); 
                    renderItemCards();
                    renderQuote();
                }
            });
        };

        // [ì™¼ìª½ íŒ¨ë„] í•­ëª© ìˆ˜ì • (Local Storage)
        window.editMasterItem = (id, event) => {
            if (event) event.stopPropagation();

            const itemIndex = allItems.findIndex(i => i.id === id);
            if (itemIndex === -1) return;
            const item = allItems[itemIndex];

            showMasterItemEditModal("í•­ëª© ìˆ˜ì •:", item.name, item.price, (result) => {
                if (result) {
                    allItems[itemIndex].name = result.name;
                    allItems[itemIndex].price = result.price;
                    saveMasterItemsToLocal();

                    // ë§ˆìŠ¤í„° ë°ì´í„° ì—…ë°ì´íŠ¸ í›„ ê²¬ì ì„œ ë™ê¸°í™” ë° ë Œë”ë§
                    updateSelectedItemsFromMaster(); 
                    renderItemCards();
                    renderQuote(); 
                }
            });
        };


        // === ì˜¤ë¥¸ìª½ íŒ¨ë„: ê²¬ì ì„œ ë¡œì§ ===

        const addItemToQuote = (item) => {
            // ê²¬ì ì„œì— ì¶”ê°€ëœ í•­ëª©ì€ ë§ˆìŠ¤í„° ì•„ì´í…œì˜ ìµœì‹  ì •ë³´ë¥¼ ë°˜ì˜í•˜ë˜, 
            // ìˆ˜ëŸ‰(count)ì´ë‚˜ ê²¬ì ì„œ ë‚´ì—ì„œ ìˆ˜ì •ëœ ì´ë¦„/ë‹¨ê°€ëŠ” ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.
            
            // ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì¸ì§€ í™•ì¸ (sourceIdëŠ” ë§ˆìŠ¤í„° ì•„ì´í…œì˜ ID)
            const existing = selectedItems.find(i => i.sourceId === item.id);
            if (existing) {
                // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ìˆ˜ëŸ‰ë§Œ ì¦ê°€
                existing.count++;
            } else {
                // ìƒˆë¡œ ì¶”ê°€í•  ë•ŒëŠ” ë§ˆìŠ¤í„° í•­ëª© ì •ë³´ë¥¼ ë³µì‚¬
                selectedItems.push({
                    sourceId: item.id, 
                    category: item.category,
                    name: item.name,
                    price: item.price,
                    count: 1
                });
            }
            renderQuote();
        };

        window.removeQuoteItem = (index) => {
            selectedItems.splice(index, 1);
            renderQuote();
        };

        window.updateQuoteItem = (index, field, value) => {
            if (!selectedItems[index]) return;
            
            if (field === 'count') {
                const val = parseInt(value);
                if (val < 1 || isNaN(val)) {
                    // ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ ì…ë ¥ ì‹œ 1ë¡œ ê°•ì œ ì„¤ì •
                    selectedItems[index].count = 1;
                } else {
                    selectedItems[index].count = val;
                }
            } else if (field === 'price') {
                const val = parseInt(value);
                if (isNaN(val) || val < 0) {
                     // ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ ì…ë ¥ ì‹œ 0ìœ¼ë¡œ ê°•ì œ ì„¤ì •
                    selectedItems[index].price = 0;
                } else {
                    selectedItems[index].price = val;
                }
            } else if (field === 'name') {
                selectedItems[index].name = value;
            }
            renderQuote();
        };

        const renderQuote = () => {
            quoteItemsBody.innerHTML = '';

            if (selectedItems.length === 0) {
                const placeholderRow = document.createElement('tr');
                placeholderRow.id = 'placeholder-row';
                placeholderRow.innerHTML = `
                    <td colspan="6" class="border border-gray-400 p-12 text-center text-gray-400 bg-gray-50 italic">
                        ì™¼ìª½ ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.<br>
                        (ì¶”ê°€ í›„ ì´ë¦„ê³¼ ê°€ê²©ì„ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
                    </td>
                `;
                quoteItemsBody.appendChild(placeholderRow);
                
                subTotalElement.textContent = "0";
                vatAmountElement.textContent = "0";
                tableGrandTotalElement.textContent = "0 ì›";

            } else {
                let totalSupply = 0;

                selectedItems.forEach((item, index) => {
                    // countë‚˜ priceê°€ NaNì¼ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ê³„ì‚° ì˜¤ë¥˜ ë°©ì§€
                    const count = isNaN(item.count) ? 0 : item.count;
                    const price = isNaN(item.price) ? 0 : item.price;
                    
                    const supplyPrice = price * count;
                    const tax = Math.round(supplyPrice * 0.1);
                    totalSupply += supplyPrice;

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 group transition-colors border-b border-gray-200 last:border-0";
                    tr.innerHTML = `
                        <td class="p-2 text-center text-gray-500 border-r border-gray-300">${index + 1}</td>
                        
                        <!-- í’ˆëª… (ì¹´í…Œê³ ë¦¬ í¬í•¨) -->
                        <td class="p-2 border-r border-gray-300 relative">
                            <div class="flex items-center">
                                ${item.category ? `<span class="text-[10px] text-indigo-500 bg-indigo-50 px-1 rounded mr-1 whitespace-nowrap no-print">[${item.category}]</span>` : ''}
                                <input type="text" 
                                    value="${item.name}" 
                                    onchange="updateQuoteItem(${index}, 'name', this.value)"
                                    class="w-full bg-transparent font-medium text-gray-800 focus:bg-white focus:ring-1 focus:ring-indigo-500 rounded px-1 outline-none"
                                >
                            </div>
                            <button onclick="removeQuoteItem(${index})" class="no-print absolute right-1 top-1/2 -translate-y-1/2 text-red-300 hover:text-red-600 opacity-0 group-hover:opacity-100 transition p-1">
                                âŒ
                            </button>
                        </td>

                        <td class="p-2 text-center border-r border-gray-300">
                            <input type="number" min="1" 
                                value="${item.count}" 
                                onchange="updateQuoteItem(${index}, 'count', this.value)"
                                class="w-16 text-center bg-transparent focus:bg-white focus:ring-1 focus:ring-indigo-500 rounded px-1 outline-none"
                            >
                        </td>

                        <td class="p-2 text-right border-r border-gray-300">
                            <input type="number" 
                                value="${item.price}" 
                                onchange="updateQuoteItem(${index}, 'price', this.value)"
                                class="w-full text-right bg-transparent text-gray-600 focus:bg-white focus:ring-1 focus:ring-indigo-500 rounded px-1 outline-none"
                            >
                        </td>

                        <td class="p-2 text-right font-medium border-r border-gray-300 text-gray-800">
                            ${formatNumber(supplyPrice)}
                        </td>

                        <td class="p-2 text-right text-gray-500 text-xs">
                            ${formatNumber(tax)}
                        </td>
                    `;
                    quoteItemsBody.appendChild(tr);
                });

                const totalTax = Math.round(totalSupply * 0.1);
                const grandTotal = totalSupply + totalTax;

                subTotalElement.textContent = formatNumber(totalSupply);
                vatAmountElement.textContent = formatNumber(totalTax);
                tableGrandTotalElement.textContent = formatNumber(grandTotal) + " ì›";
            }
        };

        // ì—”í„°í‚¤ë¡œ í•­ëª© ì¶”ê°€
        newItemPriceInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addNewCustomItem();
        });

        const printQuote = () => window.print();
        
        const clearQuote = () => {
            showCustomConfirm("ê²¬ì ì„œ ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", (isConfirmed) => {
                if(isConfirmed) {
                    selectedItems = [];
                    displayCustomerName.value = "ê³ ê°ì‚¬/ë‹´ë‹¹ì";
                    renderQuote();
                }
            });
        };
        
        window.clearQuote = clearQuote;
        window.printQuote = printQuote;

        // ì´ˆê¸°í™” í•¨ìˆ˜
        const initializeApp = () => {
            initMetaInfo();
            // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ í•­ëª©ì„ ë¡œë“œí•©ë‹ˆë‹¤. (ë°ì´í„°ê°€ ì—†ìœ¼ë©´ CSV ë°ì´í„°ë¡œ ì´ˆê¸°í™”)
            loadMasterItemsFromLocal(); 
            // 'ìƒˆ í•­ëª© ë“±ë¡' ë“œë¡­ë‹¤ìš´ ë©”ë‰´ë¥¼ CATEGORIES ëª©ë¡ì— ê¸°ë°˜í•˜ì—¬ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            newItemCategoryInput.innerHTML = '<option value="" disabled selected>ëŒ€ë¶„ë¥˜ ì„ íƒ</option>';
            CATEGORIES.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                newItemCategoryInput.appendChild(option);
            });

            renderItemCards();
            renderQuote(); // ê²¬ì ì„œ ì´ˆê¸° ë Œë”ë§
        };

        window.onload = initializeApp;
    </script>
</body>
</html>

